---
import Layout from "../../layouts/Layout.astro";
import data from "../../data/tools.json";
import metadata from "../../data/metadata.json";
import "@new-ui/foundations";

export function getStaticPaths() {
  const paths: any[] = [];

  data.tools.forEach((category: any) => {
    category.content.forEach((tool: any) => {
      if (tool.slug) {
        paths.push({ params: { slug: tool.slug } });
      }
    });
  });

  return paths;
}

export const prerender = true;

const { slug } = Astro.params;
const found =
  data.tools.flatMap((t) => t.content).find((x) => x.slug === slug) || null;

if (!found) {
  // If slug not found, render not-found behaviour (Astro will handle as 404)
  throw new Error(`Tool not found: ${slug}`);
}

const tool = found;
const category = tool.category || "all";

// helpers
function extractDomain(url: string) {
  try {
    return new URL(url).hostname.replace("www.", "");
  } catch {
    return "";
  }
}
function formatDate(dateStr: string) {
  try {
    return new Date(dateStr).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  } catch {
    return dateStr;
  }
}

const domain = extractDomain(tool.url || "");
const formattedDate = formatDate(tool["date-added"]);
const canonicalUrl = `https://riseofmachine.com/tools/${tool.slug}`;
const faviconUrl = `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
const fallbackPath = category === "all" ? "/" : `/${category}`;

// Get pre-fetched metadata if available
const meta = (metadata as any)[slug] || {};

const seoTitle = meta.title || tool.title;
const seoDescription = meta.description || tool.body;
// We don't have OG images in the new simplified metadata, so falling back to favicon or site default
const seoOgImage = faviconUrl;
const seoOgType = "website";
const seoOgSiteName = "Rise of Machine";

const shareText = `Check out ${tool.title} - ${tool.body}`;
const encodedShareText = encodeURIComponent(shareText);
const encodedCanonicalUrl = encodeURIComponent(canonicalUrl);
const xShareUrl = `https://x.com/intent/post?text=${encodedShareText}&url=${encodedCanonicalUrl}&via=planetabhi`;
const linkedinShareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedCanonicalUrl}`;
const redditShareUrl = `https://www.reddit.com/submit?url=${encodedCanonicalUrl}&title=${encodedShareText}`;
---

<Layout
  site={`Rise of Machine - ${tool.title}`}
  title={tool.title}
  tagline={tool.body}
  pageTitle={seoTitle}
  pageDescription={seoDescription}
  canonicalUrl={canonicalUrl}
  ogTitle={seoTitle}
  ogDescription={seoDescription}
  ogUrl={canonicalUrl}
  ogImage={seoOgImage}
  ogType={seoOgType}
  ogSiteName={seoOgSiteName}
  twitterCard="summary"
  twitterTitle={seoTitle}
  twitterDescription={seoDescription}
  twitterImage={seoOgImage}
  pageFavicon={faviconUrl}
>
  <main>
    <div class="tool-detail-modal-backdrop" id="modalBackdrop">
      <div
        class="tool-detail-modal"
        id="toolModal"
        data-fallback={fallbackPath}
      >
        <button
          class="tool-detail-close-btn"
          id="closeModal"
          title="Close (Press ESC)"
          aria-label="Close tool details"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            fill="none"
            viewBox="0 0 24 24"
            ><path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M18 6L6 18M6 6l12 12"></path></svg
          >
        </button>

        <div class="tool-detail-header">
          <div class="tool-icon-container">
            <img
              src={faviconUrl}
              alt={`${tool.title} icon`}
              class="tool-icon"
              onerror="this.style.display='none'"
            />
          </div>
          <div class="tool-header-content">
            <h1 class="tool-title">{tool.title}</h1>
            <p class="tool-meta">Added on {formattedDate}</p>
          </div>
        </div>

        <div class="tool-detail-content">
          <section class="tool-summary">
            <article>
              <p class="snapshot-label">About</p>
              <p class="tool-description">{tool.body}</p>
            </article>

            <div class="snapshot-grid">
              <article class="snapshot-card">
                <p class="snapshot-label">Pricing</p>
                <p class="snapshot-value">{tool.tag}</p>
              </article>
              <article class="snapshot-card">
                <p class="snapshot-label">Official site</p>
                {
                  tool.url ? (
                    <a
                      href={tool.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="snapshot-value link-muted"
                    >
                      {domain || tool.url}
                    </a>
                  ) : (
                    <p class="snapshot-value snapshot-value--muted">
                      Not provided
                    </p>
                  )
                }
              </article>
            </div>

            <div class="tool-detail-actions">
              {
                tool.url ? (
                  <a
                    href={tool.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-primary"
                  >
                    Visit {tool.title}
                  </a>
                ) : (
                  <span class="btn-primary btn-disabled" aria-disabled="true">
                    No website listed
                  </span>
                )
              }
            </div>
          </section>

          <div class="tool-detail-share">
            <h3 class="share-title">Share this tool</h3>
            <div class="share-buttons">
              <a
                href={xShareUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="share-btn"
                title="Share on X"
                aria-label="Share on X"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  fill="currentColor"
                  viewBox="0 0 256 256"
                  ><path
                    d="M214.75,211.71l-62.6-98.38,61.77-67.95a8,8,0,0,0-11.84-10.76L143.24,99.34,102.75,35.71A8,8,0,0,0,96,32H48a8,8,0,0,0-6.75,12.3l62.6,98.37-61.77,68a8,8,0,1,0,11.84,10.76l58.84-64.72,40.49,63.63A8,8,0,0,0,160,224h48a8,8,0,0,0,6.75-12.29ZM164.39,208,62.57,48h29L193.43,208Z"
                  ></path></svg
                >
              </a>
              <a
                href={linkedinShareUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="share-btn"
                title="Share on LinkedIn"
                aria-label="Share on LinkedIn"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  fill="currentColor"
                  viewBox="0 0 256 256"
                  ><path
                    d="M216,24H40A16,16,0,0,0,24,40V216a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V40A16,16,0,0,0,216,24Zm0,192H40V40H216V216ZM96,112v64a8,8,0,0,1-16,0V112a8,8,0,0,1,16,0Zm88,28v36a8,8,0,0,1-16,0V140a20,20,0,0,0-40,0v36a8,8,0,0,1-16,0V112a8,8,0,0,1,15.79-1.78A36,36,0,0,1,184,140ZM100,84A12,12,0,1,1,88,72,12,12,0,0,1,100,84Z"
                  ></path></svg
                >
              </a>
              <a
                href={redditShareUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="share-btn"
                title="Share on Reddit"
                aria-label="Share on Reddit"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  fill="currentColor"
                  viewBox="0 0 256 256"
                  ><path
                    d="M248,104a32,32,0,0,0-52.94-24.19c-16.75-8.9-36.76-14.28-57.66-15.53l5.19-31.17,17.72,2.72a24,24,0,1,0,2.87-15.74l-26-4a8,8,0,0,0-9.11,6.59L121.2,64.16c-21.84.94-42.82,6.38-60.26,15.65a32,32,0,0,0-42.59,47.74A59,59,0,0,0,16,144c0,21.93,12,42.35,33.91,57.49C70.88,216,98.61,224,128,224s57.12-8,78.09-22.51C228,186.35,240,165.93,240,144a59,59,0,0,0-2.35-16.45A32.16,32.16,0,0,0,248,104ZM184,24a8,8,0,1,1-8,8A8,8,0,0,1,184,24Zm40.13,93.78a8,8,0,0,0-3.29,10A43.58,43.58,0,0,1,224,144c0,16.53-9.59,32.27-27,44.33C178.67,201,154.17,208,128,208s-50.67-7-69-19.67C41.59,176.27,32,160.53,32,144a43.75,43.75,0,0,1,3.14-16.17,8,8,0,0,0-3.27-10A16,16,0,1,1,52.94,94.59a8,8,0,0,0,10.45,2.23l.36-.22C81.45,85.9,104.25,80,128,80h0c23.73,0,46.53,5.9,64.23,16.6l.42.25a8,8,0,0,0,10.39-2.26,16,16,0,1,1,21.07,23.19ZM88,144a16,16,0,1,1,16-16A16,16,0,0,1,88,144Zm96-16a16,16,0,1,1-16-16A16,16,0,0,1,184,128Zm-16.93,44.25a8,8,0,0,1-3.32,10.82,76.18,76.18,0,0,1-71.5,0,8,8,0,1,1,7.5-14.14,60.18,60.18,0,0,0,56.5,0A8,8,0,0,1,167.07,172.25Z"
                  ></path></svg
                >
              </a>
              <button
                class="share-btn"
                id="copyLinkBtn"
                title="Copy link to clipboard"
                aria-label="Copy link to clipboard"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  fill="currentColor"
                  viewBox="0 0 256 256"
                  ><path
                    d="M240,88.23a54.43,54.43,0,0,1-16,37L189.25,160a54.27,54.27,0,0,1-38.63,16h-.05A54.63,54.63,0,0,1,96,119.84a8,8,0,0,1,16,.45A38.62,38.62,0,0,0,150.58,160h0a38.39,38.39,0,0,0,27.31-11.31l34.75-34.75a38.63,38.63,0,0,0-54.63-54.63l-11,11A8,8,0,0,1,135.7,59l11-11A54.65,54.65,0,0,1,224,48,54.86,54.86,0,0,1,240,88.23ZM109,185.66l-11,11A38.41,38.41,0,0,1,70.6,208h0a38.63,38.63,0,0,1-27.29-65.94L78,107.31A38.63,38.63,0,0,1,144,135.71a8,8,0,0,0,16,.45A54.86,54.86,0,0,0,144,96a54.65,54.65,0,0,0-77.27,0L32,130.75A54.62,54.62,0,0,0,70.56,224h0a54.28,54.28,0,0,0,38.64-16l11-11A8,8,0,0,0,109,185.66Z"
                  ></path></svg
                >
              </button>
            </div>
          </div>

          <div class="tool-detail-nav">
            <a href={category === "all" ? "/" : `/${category}`} class="nav-link"
              >‚Üê Go back to {category === "all" ? "all" : category}</a
            >
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    (function () {
      const modalEl = document.getElementById("toolModal");
      const fallbackNavigateTo = modalEl?.dataset.fallback || "/";
      const hasSameOriginReferrer = (() => {
        try {
          if (!document.referrer) return false;
          const ref = new URL(document.referrer);
          return ref.origin === window.location.origin;
        } catch {
          return false;
        }
      })();

      function closeModal() {
        // remove modal marker before navigating back
        document.body.removeAttribute("data-modal-open");
        document.body.style.overflow = "";
        if (hasSameOriginReferrer && window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = fallbackNavigateTo;
        }
      }

      // Delegate clicks for close, backdrop, and copy
      document.addEventListener("click", (e) => {
        const close = e.target.closest(".tool-detail-close-btn");
        if (close) return closeModal();

        // If clicked outside the modal but inside backdrop
        const backdrop = e.target.closest(".tool-detail-modal-backdrop");
        const modal = e.target.closest(".tool-detail-modal");
        if (backdrop && !modal) return closeModal();

        const copyBtn = e.target.closest("#copyLinkBtn");
        if (copyBtn) {
          const url = window.location.href;
          navigator.clipboard.writeText(url).then(() => {
            const original = copyBtn.innerHTML;
            copyBtn.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            copyBtn.title = "Copied!";
            setTimeout(() => {
              copyBtn.innerHTML = original;
              copyBtn.title = "Copy link to clipboard";
            }, 2000);
          });
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      // Mark that modal is open so we can hide background elements (title/description)
      document.body.setAttribute("data-modal-open", "true");
      // Prevent background scroll while modal open
      document.body.style.overflow = "hidden";

      // Ensure state cleanup on page hide/unload
      window.addEventListener("pagehide", () => {
        document.body.removeAttribute("data-modal-open");
        document.body.style.overflow = "";
      });
      window.addEventListener("unload", () => {
        document.body.removeAttribute("data-modal-open");
        document.body.style.overflow = "";
      });
    })();
  </script>

  <style is:global>
    body[data-modal-open="true"] .title,
    body[data-modal-open="true"] .description-text {
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
      transition: opacity 120ms ease;
    }
    section {
      margin-bottom: var(--spacing-04);
    }
  </style>

  <style scoped>
    .tool-detail-modal-backdrop {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.64);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000000;
      padding: var(--spacing-05);
      overflow-y: auto;
    }

    .tool-detail-modal {
      background-color: var(--background-secondary);
      width: 100%;
      max-width: 680px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      padding: var(--spacing-09);
      background-color: var(--background);
      content-visibility: auto;
      contain-intrinsic-size: 8.5rem;
      transition: box-shadow 0.2s ease-out;
    }

    .tool-detail-close-btn {
      position: absolute;
      top: var(--spacing-06);
      right: var(--spacing-06);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--content-secondary);
      width: var(--spacing-09);
      height: var(--spacing-09);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tool-detail-close-btn:hover {
      background-color: var(--background-secondary);
      color: var(--content-primary);
    }

    .tool-detail-header {
      display: flex;
      gap: var(--spacing-06);
      align-items: flex-start;
      margin-bottom: var(--spacing-09);
    }

    .tool-icon {
      width: 48px;
      height: 48px;
    }

    .tool-title {
      margin: 0;
      font-size: var(--desktop-heading-06);
      line-height: var(--lh-desktop-heading-06);
      font-weight: 600;
      color: var(--content-primary);
    }

    .tool-meta {
      margin: 0;
      color: var(--content-secondary-alt);
      font-size: var(--desktop-body-sm);
      line-height: var(--lh-desktop-body-sm);
    }

    .tool-detail-content {
      display: flex;
      flex-direction: column;
    }

    .tool-summary {
      display: flex;
      flex-direction: column;
      background: var(--background-secondary);
      gap: var(--spacing-05);
      padding: var(--spacing-06);

      border: 0.5px solid var(--border-muted);
    }

    .tool-description {
      margin: 0;
      color: var(--content-primary);
      font-size: var(--desktop-body);
      line-height: var(--lh-desktop-body);
    }

    .summary-meta {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-01);
    }

    .summary-label {
      font-size: var(--desktop-caption);
      color: var(--content-secondary-alt);
      text-transform: uppercase;
    }

    .summary-value {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    .summary-value:hover {
      text-decoration: underline;
    }

    .summary-value--muted {
      color: var(--content-secondary);
      text-decoration: none;
    }

    .tool-section {
      display: flex;
      flex-direction: column;
      background: var(--background-secondary);
      gap: var(--spacing-05);
      padding: var(--spacing-06);

      border: 0.5px solid var(--border-muted);
    }

    .section-header {
      display: flex;
      gap: var(--spacing-05);
      align-items: flex-start;
    }

    .section-eyebrow {
      margin: 0;
      font-size: var(--desktop-caption);
      color: var(--content-secondary-alt);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .section-title {
      margin: 0;
      font-size: var(--desktop-h5);
      color: var(--content-primary);
    }

    .section-subtitle {
      margin: var(--spacing-01) 0 0 0;
      color: var(--content-secondary);
    }

    .snapshot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--spacing-04);
    }

    .snapshot-card {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-01);
    }

    .snapshot-label {
      margin: 0;
      font-size: var(--desktop-caption);
      color: var(--content-secondary-alt);
      text-transform: uppercase;
    }

    .snapshot-value {
      margin: 0;
      color: var(--content-primary);
      font-size: var(--desktop-body-sm);
      line-height: var(--lh-desktop-body-sm);
    }

    .snapshot-value--muted {
      color: var(--content-primary);
    }

    .category-link {
      color: var(--accent);
      text-decoration: none;
    }

    .category-link:hover {
      text-decoration: underline;
    }

    .link-muted {
      text-decoration: none;
    }

    .link-muted:hover {
      color: var(--accent);
    }

    .tool-detail-actions {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-02);
    }

    .btn-primary {
      display: inline-block;
      padding: var(--spacing-03) var(--spacing-05);
      background-color: var(--accent);
      color: var(--background-high-contrast);
      text-decoration: none;
      font-weight: 600;
      text-align: center;
      font-size: var(--desktop-body-sm);
      line-height: var(--lh-desktop-body-sm);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .action-hint {
      margin: 0;
      color: var(--content-secondary);
      font-size: var(--desktop-caption);
    }

    .live-metadata-grid {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-05);
    }

    .live-group {
    }

    .live-group-label {
      margin: 0 0 var(--spacing-03) 0;
      font-size: var(--desktop-caption);
      color: var(--content-secondary-alt);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .live-card-grid {
      display: grid;
      gap: var(--spacing-06);
    }

    .live-card {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-03);
    }

    .live-card-inline .favicon-preview {
      display: flex;
      align-items: center;
      gap: var(--spacing-03);
    }

    .live-card-image img {
      width: 100%;

      border: 1px solid var(--border-muted);
      object-fit: cover;
    }

    .live-label {
      margin: 0;
      font-size: var(--desktop-caption);
      text-transform: uppercase;
      color: var(--content-secondary-alt);
    }

    .live-value {
      margin: 0;
      color: var(--content-primary);
      font-size: var(--desktop-body-sm);
      line-height: var(--lh-desktop-body-sm);
    }

    .live-link {
      color: var(--accent);
      word-break: break-all;
      text-decoration: none;
    }

    .live-link:hover {
      text-decoration: underline;
    }

    .favicon-preview img {
      border: 1px solid var(--border-muted);
    }

    .list-pills {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-02);
    }

    .list-pills li {
      background-color: var(--background-secondary);
      padding: 0;

      font-size: var(--desktop-caption);
      color: var(--content-secondary);
    }

    .share-buttons {
      display: flex;
      gap: var(--spacing-03);
    }

    .share-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;

      background-color: var(--background);
      border: 0.5px solid var(--border-muted);
      color: var(--content-secondary);
    }

    .share-btn:hover {
      color: var(--accent);
      background-color: var(--background-secondary);
    }

    .tool-detail-nav {
      padding-top: var(--spacing-05);
      border-top: 0.5px solid var(--border-muted);
      display: flex;
      gap: var(--spacing-03);
    }

    .nav-link {
      color: var(--content-secondary);
      text-decoration: none;
    }

    .share-title {
      color: var(--content-secondary-alt);
      font-size: var(--desktop-caption);
      line-height: var(--lh-desktop-caption);
      text-transform: uppercase;
      margin-bottom: var(--spacing-04);
    }

    .tool-detail-share {
      margin: var(--spacing-06) 0;
    }

    span.tag {
      background-color: var(--background-selected);
      padding: calc(0.25rem - 1px) calc(0.5rem - 1px);
      display: inline-block;
      color: var(--content-secondary);
      font-size: var(--desktop-caption);
      line-height: var(--lh-desktop-caption);
      font-family: var(--body-copy);
    }

    @media (max-width: 768px) {
      .tool-detail-modal {
        padding: var(--spacing-06);
        margin: var(--spacing-05);
      }

      .tool-icon {
        width: 48px;
        height: 48px;
      }

      .section-header {
        flex-direction: column;
      }

      .tool-section {
        padding: var(--spacing-05);
      }
    }
  </style>
</Layout>
